@inherits DNNrocketAPI.render.DNNrocketTokens<Simplisity.SimplisityRazor>
@using DNNrocketAPI.Components;
@using Simplisity;

@AddProcessData("resourcepath", "/DesktopModules/DNNrocket/API/App_LocalResources/")

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jodit@4/es2021/jodit.min.css" />

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 20px;
    }

    .container {
        width: 100%;
        margin: 0 auto;
    }

    .control-group {
        margin-bottom: 1rem;
    }

    /* Jodit editor container */
    .jodit-container {
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .jodit-wysiwyg {
        min-height: 300px;
        padding: 1rem;
    }

        /* Match TipTap styles */
        .jodit-wysiwyg h1 {
            font-size: 1.4rem;
            margin-top: 3.5rem;
            margin-bottom: 1.5rem;
            line-height: 1.1;
        }

        .jodit-wysiwyg h2 {
            font-size: 1.2rem;
            margin-top: 3.5rem;
            margin-bottom: 1.5rem;
            line-height: 1.1;
        }

        .jodit-wysiwyg h3 {
            font-size: 1.1rem;
            margin-top: 2.5rem;
            line-height: 1.1;
        }

        .jodit-wysiwyg h4 {
            font-size: 1rem;
            margin-top: 2.5rem;
            line-height: 1.1;
        }

        .jodit-wysiwyg ul,
        .jodit-wysiwyg ol {
            padding: 0 1rem;
            margin: 1.25rem 1rem 1.25rem 0.4rem;
        }

        .jodit-wysiwyg blockquote {
            border-left: 3px solid #ccc;
            margin: 1.5rem 0;
            padding-left: 1rem;
        }

        .jodit-wysiwyg hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 2rem 0;
        }

        .jodit-wysiwyg a {
            color: #0066cc;
            text-decoration: underline;
        }

            .jodit-wysiwyg a:hover {
                color: #0052a3;
            }

        .jodit-wysiwyg pre {
            background: #0d0d0d;
            border-radius: 0.5rem;
            color: #fff;
            font-family: 'JetBrainsMono', monospace;
            margin: 1.5rem 0;
            padding: 0.75rem 1rem;
        }

            .jodit-wysiwyg pre code {
                background: none;
                color: inherit;
                font-size: 0.8rem;
            }
</style>

<div class="container">
    <div class="control-group">
        <div id="jodit-editor-@Model.GetSetting("editor_id")"></div>
    </div>
    @HiddenField(new SimplisityInfo(), Model.GetSetting("editor_xpath"), "", Model.GetSetting("editor_richtext"))
</div>

<script>
(function() {
    // Load Jodit script dynamically and wait for it to load
    function loadJoditScript(callback) {
        if (typeof Jodit !== 'undefined') {
            callback();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/jodit@4/es2021/jodit.min.js';
        script.onload = function() {
            console.log('Jodit script loaded');
            callback();
        };
        script.onerror = function() {
            console.error('Failed to load Jodit script');
        };
        document.head.appendChild(script);
    }

    // Initialize Jodit editor after script loads
    loadJoditScript(function() {
        const editorId = '@Model.GetSetting("editor_id")';
        const hiddenField = document.getElementById(editorId);
        const editorContainer = '#jodit-editor-' + editorId;
        const initialContent = `@HtmlOf(Model.GetSetting("editor_richtext"))`;

        // Check if editor already exists for this ID
        if (hiddenField && hiddenField.joditInstance) {
            console.log('Jodit editor already initialized for:', editorId);
            return;
        }

        // Configure Jodit editor to match CKEditor4/TipTap toolbar
        const config = {
            toolbar: true,
            toolbarButtonSize: 'middle',
            toolbarAdaptive: false,
            buttons: [
                'source', '|',
                'undo', 'redo', '|',
                'bold', 'italic', 'strikethrough', '|',
                'ul', 'ol', '|',
                'outdent', 'indent', '|',
                'paragraph', '|',
                'left', 'center', 'right', 'justify', '|',
                'link', 'unlink', '|',
                'hr'
            ],
            buttonsMD: [
                'source', '|',
                'undo', 'redo', '|',
                'bold', 'italic', 'strikethrough', '|',
                'ul', 'ol', '|',
                'outdent', 'indent', '|',
                'paragraph', '|',
                'left', 'center', 'right', 'justify', '|',
                'link', 'unlink', '|',
                'hr'
            ],
            buttonsSM: [
                'source', '|',
                'undo', 'redo', '|',
                'bold', 'italic', 'strikethrough', '|',
                'ul', 'ol', '|',
                'outdent', 'indent', '|',
                'paragraph', '|',
                'left', 'center', 'right', 'justify', '|',
                'link', 'unlink', '|',
                'hr'
            ],
            buttonsXS: [
                'source', '|',
                'undo', 'redo', '|',
                'bold', 'italic', 'strikethrough', '|',
                'ul', 'ol', '|',
                'paragraph', '|',
                'link', '|',
                'hr'
            ],
            controls: {
                paragraph: {
                    list: {
                        p: 'Paragraph',
                        h1: 'Heading 1',
                        h2: 'Heading 2',
                        h3: 'Heading 3',
                        h4: 'Heading 4',
                        pre: 'Preformatted'
                    }
                }
            },
            enter: 'P',
            defaultMode: Jodit.MODE_WYSIWYG,
            useSplitMode: false,
            minHeight: 300,
            height: 'auto',
            uploader: {
                insertImageAsBase64URI: false
            },
            filebrowser: {
                ajax: {
                    url: ''
                }
            },
            events: {
                change: function(value) {
                    if (hiddenField) {
                        hiddenField.value = value;
                        // Trigger change event for form dirty tracking
                        const isDirtyField = document.getElementById('isdirty');
                        if (isDirtyField) {
                            isDirtyField.value = 'true';
                        }
                    }
                },
                afterInit: function(instance) {
                    console.log('Jodit editor initialized for:', editorId);
                }
            }
        };

        // Initialize Jodit editor with unique container
        const editor = Jodit.make(editorContainer, config);

        // Store editor instance reference on hidden field to prevent duplicate initialization
        if (hiddenField) {
            hiddenField.joditInstance = editor;
        }

        // Set initial content
        if (initialContent) {
            editor.value = initialContent;
        }

        // Watch for changes in the hidden field and update editor
        if (hiddenField) {
            // Use MutationObserver to watch for value changes
            const observer = new MutationObserver(() => {
                const newContent = hiddenField.value;
                if (newContent !== editor.value) {
                    editor.value = newContent;
                    console.log('Jodit editor updated from hidden field:', newContent);
                }
            });

            // Observe attribute changes on the hidden field
            observer.observe(hiddenField, { attributes: true, attributeFilter: ['value'] });

            // Also listen for input/change events
            hiddenField.addEventListener('input', (e) => {
                const newContent = e.target.value;
                if (newContent !== editor.value) {
                    editor.value = newContent;
                    console.log('Jodit editor updated from hidden field:', newContent);
                }
            });

            hiddenField.addEventListener('change', (e) => {
                const newContent = e.target.value;
                if (newContent !== editor.value) {
                    editor.value = newContent;
                    console.log('Jodit editor updated from hidden field:', newContent);
                }
            });
        }
    });
})();
</script>