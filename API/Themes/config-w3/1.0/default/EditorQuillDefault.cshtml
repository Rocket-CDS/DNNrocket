@inherits DNNrocketAPI.render.DNNrocketTokens<Simplisity.SimplisityRazor>
@using DNNrocketAPI.Components;
@using Simplisity;

@AddProcessData("resourcepath", "/DesktopModules/DNNrocket/API/App_LocalResources/")

<link rel="stylesheet" href="https://cdn.quilljs.com/1.3.7/quill.snow.css" />

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 20px;
    }

    .container {
        width: 100%;
        margin: 0 auto;
        display: block;
        margin-bottom: 2rem;
    }

    .control-group {
        margin-bottom: 1rem;
    }

    /* Quill editor container */
    .quill-container {
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .ql-toolbar.ql-snow {
        border: 1px solid #ddd;
        border-radius: 4px 4px 0 0;
        background-color: #fff;
    }

    .ql-container.ql-snow {
        border: 1px solid #ddd;
        border-radius: 0 0 4px 4px;
        border-top: none;
        min-height: 300px;
    }

    /* Match TipTap styles */
    .ql-editor h1 {
        font-size: 1.4rem;
        margin-top: 3.5rem;
        margin-bottom: 1.5rem;
        line-height: 1.1;
    }

    .ql-editor h2 {
        font-size: 1.2rem;
        margin-top: 3.5rem;
        margin-bottom: 1.5rem;
        line-height: 1.1;
    }

    .ql-editor h3 {
        font-size: 1.1rem;
        margin-top: 2.5rem;
        line-height: 1.1;
    }

    .ql-editor h4 {
        font-size: 1rem;
        margin-top: 2.5rem;
        line-height: 1.1;
    }

    .ql-editor ul,
    .ql-editor ol {
        padding: 0 1rem;
        margin: 1.25rem 1rem 1.25rem 0.4rem;
    }

    .ql-editor blockquote {
        border-left: 3px solid #ccc;
        margin: 1.5rem 0;
        padding-left: 1rem;
    }

    .ql-editor hr {
        border: none;
        border-top: 1px solid #ddd;
        margin: 2rem 0;
    }

    .ql-editor a {
        color: #0066cc;
        text-decoration: underline;
    }

    .ql-editor a:hover {
        color: #0052a3;
    }

    .ql-editor pre {
        background: #0d0d0d;
        border-radius: 0.5rem;
        color: #fff;
        font-family: 'JetBrainsMono', monospace;
        margin: 1.5rem 0;
        padding: 0.75rem 1rem;
    }

    .ql-editor pre code {
        background: none;
        color: inherit;
        font-size: 0.8rem;
    }

    .ql-editor {
        padding: 1rem;
        font-size: 16px;
    }
</style>

<div class="container quill-container-@Model.GetSetting("editor_id")">
    <div class="control-group">
        <div id="quill-toolbar-@Model.GetSetting("editor_id")">
            <!-- Custom toolbar -->
            <button class="ql-undo" title="Undo">↶</button>
            <button class="ql-redo" title="Redo">↷</button>
            <span class="ql-formats">
                <button class="ql-bold" title="Bold"></button>
                <button class="ql-italic" title="Italic"></button>
                <button class="ql-strike" title="Strike"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-list" value="ordered" title="Numbered list"></button>
                <button class="ql-list" value="bullet" title="Bullet list"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-indent" value="-1" title="Outdent"></button>
                <button class="ql-indent" value="+1" title="Indent"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-blockquote" title="Blockquote"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-align" value="" title="Align left"></button>
                <button class="ql-align" value="center" title="Align center"></button>
                <button class="ql-align" value="right" title="Align right"></button>
                <button class="ql-align" value="justify" title="Justify"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-link" title="Link"></button>
            </span>
            <span class="ql-formats">
                <select class="ql-header" title="Format">
                    <option value="">Paragraph</option>
                    <option value="1">Heading 1</option>
                    <option value="2">Heading 2</option>
                    <option value="3">Heading 3</option>
                    <option value="4">Heading 4</option>
                </select>
            </span>
            <span class="ql-formats">
                <button class="ql-code-block" title="Preformatted"></button>
            </span>
        </div>
        <div id="quill-editor-@Model.GetSetting("editor_id")"></div>
    </div>
    @HiddenField(new SimplisityInfo(), Model.GetSetting("editor_xpath"), "", Model.GetSetting("editor_richtext"))
</div>

<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

<script>
(function() {
    // Wait for Quill to load
    function initQuillEditor() {
        if (typeof Quill === 'undefined') {
            setTimeout(initQuillEditor, 100);
            return;
        }

        const editorId = '@Model.GetSetting("editor_id")';
        const hiddenField = document.getElementById(editorId);
        const editorContainerId = '#quill-editor-' + editorId;
        const toolbarId = '#quill-toolbar-' + editorId;
        const initialContent = `@HtmlOf(Model.GetSetting("editor_richtext"))`;

        // Check if editor already exists for this ID
        if (hiddenField && hiddenField.quillInstance) {
            console.log('Quill editor already initialized for:', editorId);
            return;
        }

        // Add custom undo/redo handlers
        const icons = Quill.import('ui/icons');
        icons['undo'] = '↶';
        icons['redo'] = '↷';

        // Configure Quill with custom toolbar
        const quill = new Quill(editorContainerId, {
            theme: 'snow',
            modules: {
                toolbar: {
                    container: toolbarId,
                    handlers: {
                        'undo': function() {
                            this.quill.history.undo();
                        },
                        'redo': function() {
                            this.quill.history.redo();
                        }
                    }
                },
                history: {
                    delay: 1000,
                    maxStack: 50,
                    userOnly: true
                }
            },
            placeholder: '',
        });

        // Store editor instance reference on hidden field to prevent duplicate initialization
        if (hiddenField) {
            hiddenField.quillInstance = quill;
        }

        // Set initial content
        if (initialContent) {
            const delta = quill.clipboard.convert(initialContent);
            quill.setContents(delta, 'silent');
        }

        // Update hidden field on text change
        quill.on('text-change', function(delta, oldDelta, source) {
            if (hiddenField) {
                hiddenField.value = quill.root.innerHTML;
                // Trigger change event for form dirty tracking
                const isDirtyField = document.getElementById('isdirty');
                if (isDirtyField) {
                    isDirtyField.value = 'true';
                }
            }
        });

        // Watch for changes in the hidden field and update editor
        if (hiddenField) {
            // Use MutationObserver to watch for value changes
            const observer = new MutationObserver(() => {
                const newContent = hiddenField.value;
                if (newContent !== quill.root.innerHTML) {
                    const delta = quill.clipboard.convert(newContent);
                    quill.setContents(delta, 'silent');
                    console.log('Quill editor updated from hidden field:', editorId, newContent);
                }
            });

            // Observe attribute changes on the hidden field
            observer.observe(hiddenField, { attributes: true, attributeFilter: ['value'] });

            // Also listen for input/change events
            hiddenField.addEventListener('input', (e) => {
                const newContent = e.target.value;
                if (newContent !== quill.root.innerHTML) {
                    const delta = quill.clipboard.convert(newContent);
                    quill.setContents(delta, 'silent');
                    console.log('Quill editor updated from hidden field:', editorId, newContent);
                }
            });

            hiddenField.addEventListener('change', (e) => {
                const newContent = e.target.value;
                if (newContent !== quill.root.innerHTML) {
                    const delta = quill.clipboard.convert(newContent);
                    quill.setContents(delta, 'silent');
                    console.log('Quill editor updated from hidden field:', editorId, newContent);
                }
            });
        }

        console.log('Quill editor initialized for:', editorId);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initQuillEditor);
    } else {
        initQuillEditor();
    }
})();
</script>
