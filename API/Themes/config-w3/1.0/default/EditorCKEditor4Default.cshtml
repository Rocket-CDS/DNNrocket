@inherits DNNrocketAPI.render.DNNrocketTokens<Simplisity.SimplisityRazor>
@using DNNrocketAPI.Components;
@using Simplisity;

@AddProcessData("resourcepath", "/DesktopModules/DNNrocket/API/App_LocalResources/")

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 20px;
    }

    .container {
        width: 100%;
        margin: 0 auto;
    }

    .control-group {
        margin-bottom: 1rem;
    }

    /* CKEditor4 container */
    .cke {
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .cke_contents {
        min-height: 300px;
    }

    /* Match TipTap styles */
    .cke_wysiwyg_div h1,
    .cke_editable h1 {
        font-size: 1.4rem;
        margin-top: 3.5rem;
        margin-bottom: 1.5rem;
        line-height: 1.1;
    }

    .cke_wysiwyg_div h2,
    .cke_editable h2 {
        font-size: 1.2rem;
        margin-top: 3.5rem;
        margin-bottom: 1.5rem;
        line-height: 1.1;
    }

    .cke_wysiwyg_div h3,
    .cke_editable h3 {
        font-size: 1.1rem;
        margin-top: 2.5rem;
        line-height: 1.1;
    }

    .cke_wysiwyg_div h4,
    .cke_editable h4 {
        font-size: 1rem;
        margin-top: 2.5rem;
        line-height: 1.1;
    }

    .cke_wysiwyg_div ul,
    .cke_wysiwyg_div ol,
    .cke_editable ul,
    .cke_editable ol {
        padding: 0 1rem;
        margin: 1.25rem 1rem 1.25rem 0.4rem;
    }

    .cke_wysiwyg_div blockquote,
    .cke_editable blockquote {
        border-left: 3px solid #ccc;
        margin: 1.5rem 0;
        padding-left: 1rem;
    }

    .cke_wysiwyg_div hr,
    .cke_editable hr {
        border: none;
        border-top: 1px solid #ddd;
        margin: 2rem 0;
    }

    .cke_wysiwyg_div a,
    .cke_editable a {
        color: #0066cc;
        text-decoration: underline;
    }

        .cke_wysiwyg_div a:hover,
        .cke_editable a:hover {
            color: #0052a3;
        }

    .cke_wysiwyg_div pre,
    .cke_editable pre {
        background: #0d0d0d;
        border-radius: 0.5rem;
        color: #fff;
        font-family: 'JetBrainsMono', monospace;
        margin: 1.5rem 0;
        padding: 0.75rem 1rem;
    }

        .cke_wysiwyg_div pre code,
        .cke_editable pre code {
            background: none;
            color: inherit;
            font-size: 0.8rem;
        }
</style>

<div class="container">
    <div class="control-group">
        <textarea id="ckeditor4-editor-@Model.GetSetting("editor_id")"></textarea>
    </div>
    @HiddenField(new SimplisityInfo(), Model.GetSetting("editor_xpath"), "", Model.GetSetting("editor_richtext"))
</div>

<script>
(function() {
    // Load CKEditor4 script dynamically and wait for it to load
    function loadCKEditor4Script(callback) {
        if (typeof CKEDITOR !== 'undefined') {
            callback();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js';
        script.onload = function() {
            console.log('CKEditor4 script loaded');
            callback();
        };
        script.onerror = function() {
            console.error('Failed to load CKEditor4 script');
        };
        document.head.appendChild(script);
    }

    // Initialize CKEditor4 after script loads
    loadCKEditor4Script(function() {
        const editorId = '@Model.GetSetting("editor_id")';
        const hiddenField = document.getElementById(editorId);
        const editorTextareaId = 'ckeditor4-editor-' + editorId;
        const initialContent = `@HtmlOf(Model.GetSetting("editor_richtext"))`;

        // Check if editor already exists for this ID
        if (hiddenField && hiddenField.ckeditor4Instance) {
            console.log('CKEditor4 already initialized for:', editorId);
            return;
        }

        // Set initial content in textarea
        const textarea = document.getElementById(editorTextareaId);
        if (textarea && initialContent) {
            textarea.value = initialContent;
        }

        // Configure CKEditor4 to match the config
        const config = {
            toolbar: [
                { name: 'document', items: ['Source'] },
                { name: 'clipboard', items: ['Undo', 'Redo'] },
                { name: 'basicstyles', items: ['Bold', 'Italic', 'Strike'] },
                { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'HorizontalRule', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
                { name: 'links', items: ['Link', 'Unlink', 'Anchor'] },
                { name: 'styles', items: ['Format'] }
            ],
            format_tags: 'p;h1;h2;h3;h4;pre',
            removeDialogTabs: 'image:advanced;link:advanced',
            allowedContent: true,
            height: 300,
            versionCheck: false,
            extraPlugins: 'justify',
            on: {
                instanceReady: function(evt) {
                    console.log('CKEditor4 initialized for:', editorId);
                },
                change: function(evt) {
                    if (hiddenField) {
                        hiddenField.value = evt.editor.getData();
                        // Trigger change event for form dirty tracking
                        const isDirtyField = document.getElementById('isdirty');
                        if (isDirtyField) {
                            isDirtyField.value = 'true';
                        }
                    }
                },
                key: function(evt) {
                    if (hiddenField) {
                        hiddenField.value = evt.editor.getData();
                        const isDirtyField = document.getElementById('isdirty');
                        if (isDirtyField) {
                            isDirtyField.value = 'true';
                        }
                    }
                }
            }
        };

        // Initialize CKEditor4 with unique container
        const editor = CKEDITOR.replace(editorTextareaId, config);

        // Store editor instance reference on hidden field to prevent duplicate initialization
        if (hiddenField) {
            hiddenField.ckeditor4Instance = editor;
        }

        // Watch for changes in the hidden field and update editor
        if (hiddenField) {
            // Use MutationObserver to watch for value changes
            const observer = new MutationObserver(() => {
                const newContent = hiddenField.value;
                if (editor && newContent !== editor.getData()) {
                    editor.setData(newContent);
                    console.log('CKEditor4 updated from hidden field:', editorId, newContent);
                }
            });

            // Observe attribute changes on the hidden field
            observer.observe(hiddenField, { attributes: true, attributeFilter: ['value'] });

            // Also listen for input/change events
            hiddenField.addEventListener('input', (e) => {
                const newContent = e.target.value;
                if (editor && newContent !== editor.getData()) {
                    editor.setData(newContent);
                    console.log('CKEditor4 updated from hidden field:', editorId, newContent);
                }
            });

            hiddenField.addEventListener('change', (e) => {
                const newContent = e.target.value;
                if (editor && newContent !== editor.getData()) {
                    editor.setData(newContent);
                    console.log('CKEditor4 updated from hidden field:', editorId, newContent);
                }
            });
        }
    });
})();
</script>
